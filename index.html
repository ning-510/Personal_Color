<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Personal Color å½©å¦é¡§å•</title>
    <style>
        :root {
            --primary: #A59395; /* è«è˜­è¿ªç…™ç²‰ç´« */
            --primary-hover: #8F7D7F; /* è¼ƒæ·±çš„ç…™ç²‰ç´« */
            --bg-color: #F4F1F1; /* æ¥µæ·ºçš„æš–ç°èƒŒæ™¯ */
            --text-main: #4A4344; /* æ·±æš–ç°æ–‡å­— */
            --text-muted: #807677; /* ä¸­æ€§æš–ç° */
            --card-bg: #FFFFFF;
            --border-color: #DCD7D7; /* æŸ”å’Œçš„é‚Šæ¡†è‰² */
            --radius: 16px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            overflow-x: hidden;
            width: 100%;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 480px;
            margin-top: 20px;
            box-sizing: border-box;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 24px;
            margin: 0 0 8px 0;
            color: var(--text-main);
        }

        .header p {
            font-size: 14px;
            color: var(--text-muted);
            margin: 0;
        }

        /* åˆ†é æ¨™ç±¤è¨­è¨ˆ */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            background-color: #EBE6E6;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .tab.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(165, 147, 149, 0.3);
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        /* è¼¸å…¥æ¡†å®¹å™¨ (ç‚ºäº†æ”¾æ¸…é™¤æŒ‰éˆ•) */
        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        input[type="text"], input[type="password"], select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            box-sizing: border-box;
            transition: border-color 0.2s;
            background-color: #FCFAFA;
        }

        .input-with-clear {
            padding-right: 40px !important; 
        }

        .clear-btn {
            position: absolute;
            right: 8px;
            background: transparent;
            border: none;
            color: #B0A1A4;
            font-size: 18px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
            border-radius: 50%;
        }
        
        .clear-btn:hover {
            background-color: #F0EDED;
            color: var(--text-main);
            transform: scale(1);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            background-color: #FFFFFF;
        }

        button.primary-btn {
            width: 100%;
            padding: 14px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }

        button.primary-btn:hover {
            background-color: var(--primary-hover);
        }

        button.primary-btn:active {
            transform: scale(0.98);
        }

        button.primary-btn:disabled {
            background-color: #D3CDCD;
            cursor: not-allowed;
            transform: none;
        }

        .button-secondary {
            background-color: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border-color);
            margin-top: 10px;
            width: 100%;
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .button-secondary:hover {
            background-color: #F0EDED;
        }

        .hidden {
            display: none !important;
        }

        /* é›™æŒ‰éˆ•ä¸Šå‚³å°ˆç”¨æ¨£å¼ */
        .upload-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .upload-btn {
            flex: 1;
            padding: 12px 0;
            background-color: #FFFFFF;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.2s;
            display: block;
        }
        
        .upload-btn:hover {
            background-color: #F9F9F9;
            border-color: var(--primary);
        }
        
        .hidden-file-input {
            display: none;
        }

        /* è¼‰å…¥å‹•ç•« */
        .loader {
            border: 3px solid #EBE6E6;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-container {
            text-align: center;
            padding: 20px 0;
        }

        .loading-text {
            margin-top: 10px;
            font-size: 14px;
            color: var(--text-muted);
        }

        /* çµæœå±•ç¤ºå€ */
        .result-box {
            background-color: #F6F3F3;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #EBE6E6;
        }

        .result-score {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
            text-align: center;
            margin-bottom: 10px;
        }

        .result-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #8B6D71;
        }

        .result-text {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 0;
            color: var(--text-main);
        }
        
        .tag {
            display: inline-block;
            background-color: #EBE6E6;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            color: #6D6364;
            margin-bottom: 16px;
        }

        .fashion-tag {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            margin-right: 6px;
            margin-bottom: 8px;
        }

        /* æ¨è–¦æ¸…å–®å°ˆç”¨æ¨£å¼ */
        .rec-item {
            padding: 16px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .rec-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        .rec-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        .rec-brand {
            font-weight: bold;
            color: var(--primary);
            font-size: 14px;
        }
        .rec-type-tag {
            font-size: 11px;
            background-color: #F6F3F3;
            color: #8B6D71;
            padding: 2px 8px;
            border-radius: 12px;
        }
        .rec-product {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 6px;
        }
        .rec-reason {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.5;
            margin: 0;
        }
        
        /* éŒ¯èª¤æç¤ºæ¨£å¼ */
        .error-message {
            color: #D32F2F;
            font-size: 13px;
            background-color: #FDEDED;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #F3D8D8;
            margin-top: 10px;
            line-height: 1.5;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Personal Color é¡§å•</h1>
        <p>AI å³æ™‚åˆ†æä½ çš„å‘½å®šå½©å¦èˆ‡æœé£¾</p>
    </div>

    <!-- å€å¡Š 1ï¼šAPI Key è¨­å®š (åƒ…é¦–æ¬¡é¡¯ç¤º) -->
    <div class="card" id="api-key-section">
        <h2 style="font-size: 18px; margin-top: 0; color: #8B6D71;">ğŸ”‘ ç³»çµ±é©—è­‰</h2>
        <div class="form-group">
            <label for="api-key-input">è«‹è¼¸å…¥å°ˆå±¬é€šé—œå¯†ç¢¼ (API Key)</label>
            <input type="password" id="api-key-input" placeholder="è²¼ä¸Š Gemini API Key">
            <p style="font-size: 12px; color: #888; margin-top: 6px;">å¯†ç¢¼åƒ…å„²å­˜æ–¼æ‚¨çš„è¨­å‚™ä¸­ï¼Œç¢ºä¿å®‰å…¨ä¸”ä¸æœƒè¢«ä»–äººå…±ç”¨é¡åº¦ã€‚</p>
        </div>
        <button class="primary-btn" onclick="saveApiKey()">ç¢ºèªå„²å­˜</button>
    </div>

    <!-- å€å¡Š 2ï¼šå€‹äººè‰²å½©è¨­å®š (è¨­å®šéå¾Œå¯éš±è—) -->
    <div class="card hidden" id="season-section">
        <h2 style="font-size: 18px; margin-top: 0;">1. è¨­å®šä½ çš„å°ˆå±¬å­£å‹</h2>
        
        <!-- ç…§ç‰‡ä¸Šå‚³èˆ‡ AI åˆ†æå€å¡Š -->
        <div class="form-group" style="background-color: #FCFAFA; padding: 16px; border-radius: 12px; margin-bottom: 20px; border: 1px dashed var(--border-color);">
            <label style="color: var(--primary); font-size: 16px;">âœ¨ ç›¸æ©Ÿ / ç…§ç‰‡ AI æ¸¬è‰²</label>
            <p style="font-size: 13px; color: var(--text-muted); margin-top: 4px; margin-bottom: 12px;">è«‹åœ¨è‡ªç„¶å…‰ä¸‹æ‹æ”ç´ é¡ç…§ï¼Œä»¥ç²å¾—æœ€æº–ç¢ºçš„çµæœã€‚</p>
            
            <div class="upload-buttons">
                <label class="upload-btn">
                    ğŸ“¸ é–‹å•Ÿç›¸æ©Ÿ
                    <input type="file" class="hidden-file-input" accept="image/*" capture="user" onchange="previewImage(event)">
                </label>
                <label class="upload-btn">
                    ğŸ–¼ï¸ å¾ç›¸ç°¿é¸æ“‡
                    <input type="file" class="hidden-file-input" accept="image/*" onchange="previewImage(event)">
                </label>
            </div>
            
            <div id="photo-preview-container" class="hidden" style="text-align: center; margin-top: 12px;">
                <img id="photo-preview" style="max-width: 100%; max-height: 250px; border-radius: 8px; border: 1px solid var(--border-color);">
                <button id="analyze-photo-btn" class="primary-btn" onclick="analyzeSeasonFromPhoto()" style="margin-top: 12px; background-color: #9BACA3;">é–‹å§‹ AI æ¸¬è‰²</button>
            </div>
            
            <div class="loading-container hidden" id="season-loading-spinner">
                <div class="loader" style="border-top-color: #9BACA3;"></div>
                <div class="loading-text">AI æ­£åœ¨åˆ†æä½ çš„è†šè‰²åŸºå› ...</div>
            </div>
        </div>

        <div style="text-align: center; color: #B0A1A4; font-size: 13px; margin-bottom: 16px;">â€” æˆ–æ‰‹å‹•é¸æ“‡ â€”</div>

        <div class="form-group">
            <select id="season-select">
                <option value="" disabled selected>è«‹é¸æ“‡ä½ çš„å››å­£è‰²å½©...</option>
                <optgroup label="æ˜¥å­£ (Spring)">
                    <option value="æ˜¥å­£æ·ºè‰²å‹ (Light Spring)">æ˜¥å­£æ·ºè‰²å‹ (Light Spring)</option>
                    <option value="æ˜¥å­£æš–è‰²å‹ (Warm Spring)">æ˜¥å­£æš–è‰²å‹ (Warm Spring)</option>
                    <option value="æ˜¥å­£æ·¨è‰²å‹ (Clear Spring)">æ˜¥å­£æ·¨è‰²å‹ (Clear Spring)</option>
                </optgroup>
                <optgroup label="å¤å­£ (Summer)">
                    <option value="å¤å­£æ·ºè‰²å‹ (Light Summer)">å¤å­£æ·ºè‰²å‹ (Light Summer)</option>
                    <option value="å¤å­£å†·è‰²å‹ (Cool Summer)">å¤å­£å†·è‰²å‹ (Cool Summer)</option>
                    <option value="å¤å­£æŸ”å’Œå‹ (Soft Summer)">å¤å­£æŸ”å’Œå‹ (Soft Summer)</option>
                </optgroup>
                <optgroup label="ç§‹å­£ (Autumn)">
                    <option value="ç§‹å­£æŸ”å’Œå‹ (Soft Autumn)">ç§‹å­£æŸ”å’Œå‹ (Soft Autumn)</option>
                    <option value="ç§‹å­£æš–è‰²å‹ (Warm Autumn)">ç§‹å­£æš–è‰²å‹ (Warm Autumn)</option>
                    <option value="ç§‹å­£æ·±è‰²å‹ (Deep Autumn)">ç§‹å­£æ·±è‰²å‹ (Deep Autumn)</option>
                </optgroup>
                <optgroup label="å†¬å­£ (Winter)">
                    <option value="å†¬å­£æ·¨è‰²å‹ (Clear Winter)">å†¬å­£æ·¨è‰²å‹ (Clear Winter)</option>
                    <option value="å†¬å­£å†·è‰²å‹ (Cool Winter)">å†¬å­£å†·è‰²å‹ (Cool Winter)</option>
                    <option value="å†¬å­£æ·±è‰²å‹ (Deep Winter)">å†¬å­£æ·±è‰²å‹ (Deep Winter)</option>
                </optgroup>
            </select>
        </div>
        <button class="primary-btn" onclick="saveSeason()">è¨­å®šå®Œæˆ</button>
    </div>

    <!-- ä¸»è¦å…§å®¹å€ (è¨­å®šå­£å‹å¾Œé¡¯ç¤º) -->
    <div id="main-content-area" class="hidden">
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 0 4px;">
            <span class="tag" id="current-season-tag" style="margin-bottom: 0; background-color: var(--primary); color: white;">å°šæœªè¨­å®šå­£å‹</span>
            <button class="button-secondary" style="width: auto; padding: 6px 12px; margin: 0; font-size: 13px;" onclick="editSeason()">âš™ï¸ ä¿®æ”¹å­£å‹</button>
        </div>

        <!-- å°è¦½åˆ†é  -->
        <div class="tabs" id="main-tabs">
            <div class="tab active" onclick="switchTab('makeup')">ğŸ’„ å½©å¦é¡§å•</div>
            <div class="tab" onclick="switchTab('fashion')">ğŸ‘— æœé£¾é£¾å“</div>
        </div>

        <!-- ==================== å½©å¦åˆ†é  ==================== -->
        <div id="makeup-tab-content" class="tab-content">
            
            <!-- å–®å“åˆ†æ -->
            <div class="card">
                <h2 style="font-size: 18px; margin-top: 0;">ğŸ” é€™æ¬¾å½©å¦é©åˆæˆ‘å—ï¼Ÿ</h2>
                <div class="form-group">
                    <div class="input-wrapper">
                        <input type="text" id="product-input" class="input-with-clear" placeholder="è²¼ä¸Šç¶²å€æˆ–è¼¸å…¥ç”¢å“ (ä¾‹: MAC Chili)">
                        <button class="clear-btn" onclick="clearInput('product-input')">âœ–</button>
                    </div>
                </div>
                <button class="primary-btn" id="analyze-btn" onclick="analyzeProduct()">é–‹å§‹åˆ†æ</button>

                <div class="loading-container hidden" id="loading-spinner">
                    <div class="loader"></div>
                    <div class="loading-text">AI æ­£åœ¨æœå°‹èˆ‡åˆ†æç”¢å“æˆåˆ†...</div>
                </div>

                <div class="result-box hidden" id="result-container">
                    <div class="result-score" id="result-score">-- åˆ†</div>
                    <div class="result-title" id="result-summary">è‰²å½©ç¸½çµ</div>
                    <p class="result-text" id="result-reason">åˆ†æåŸå› ...</p>
                </div>
            </div>

            <!-- å“ç‰Œå°‹å¯¶å€ -->
            <div class="card">
                <h2 style="font-size: 18px; margin-top: 0;">ğŸ¯ å“ç‰Œå°‹å¯¶ (ç†±é–€æ¦œå–®æ¨è–¦)</h2>
                <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">ä¸çŸ¥é“è©²æŒ‘å“ªæ¬¾ï¼Ÿè®“ AI çµåˆ @Cosme èˆ‡ Olive Young ç†±é–€æ¦œå–®ç‚ºä½ åš´é¸ï¼</p>
                
                <div class="form-group">
                    <label>æƒ³æ‰¾ä»€éº¼éƒ¨ä½çš„å½©å¦ï¼Ÿ</label>
                    <select id="makeup-category-select" style="margin-bottom: 12px;">
                        <option value="å…¨è‡‰å½©å¦ (ç¶œåˆæ¨è–¦)">âœ¨ å…¨è‡‰å½©å¦ (ç¶œåˆæ¨è–¦)</option>
                        <option value="å”‡è† / å£ç´… / å”‡é‡‰">ğŸ’„ å”‡è† / å£ç´… / å”‡é‡‰</option>
                        <option value="è…®ç´… / é °å½©">ğŸ˜Š è…®ç´… / é °å½©</option>
                        <option value="çœ¼å½± / çœ¼å¦">ğŸ‘ï¸ çœ¼å½± / çœ¼å¦</option>
                        <option value="çœ‰ç­† / æŸ“çœ‰è†">âœï¸ çœ‰ç­† / æŸ“çœ‰è†</option>
                        <option value="é®ç‘• (é»‘çœ¼åœˆ / æ·šæº / ç—˜å°)">ğŸª„ é®ç‘• (é»‘çœ¼åœˆ / æ·šæº / ç—˜å°)</option>
                        <option value="ä¿®å®¹ / æ‰“äº®">ğŸŒŸ ä¿®å®¹ / æ‰“äº®</option>
                        <option value="ç²‰åº• / åº•å¦">ğŸ§´ ç²‰åº• / åº•å¦</option>
                    </select>
                    
                    <label>è¼¸å…¥å“ç‰Œ (é¸å¡«)</label>
                    <div class="input-wrapper">
                        <input type="text" id="brand-input" class="input-with-clear" placeholder="ä¾‹å¦‚ï¼šMAC, æ¤æ‘ç§€, ROM&ND (ç•™ç™½å‰‡ä¸é™å“ç‰Œ)">
                        <button class="clear-btn" onclick="clearInput('brand-input')">âœ–</button>
                    </div>
                </div>
                <button class="primary-btn" id="analyze-brand-btn" onclick="analyzeBrand()" style="background-color: #8B9BAA;">æœå°‹é©åˆæˆ‘çš„ç”¢å“</button>

                <div class="loading-container hidden" id="brand-loading-spinner">
                    <div class="loader" style="border-top-color: #8B9BAA;"></div>
                    <div class="loading-text">AI æ­£åœ¨æ¯”å°æ—¥éŸ“ç†±é–€æ’è¡Œæ¦œèˆ‡ä½ çš„å­£å‹...</div>
                </div>

                <div id="brand-result-list" style="margin-top: 16px;">
                    <!-- å“ç‰Œæ¨è–¦é …ç›®æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
                </div>
            </div>

            <!-- å°ˆå±¬æ¨è–¦æ¸…å–® -->
            <div class="card" id="recommendations-section">
                <h2 style="font-size: 18px; margin-top: 0; margin-bottom: 16px;">âœ¨ ä½ çš„å°ˆå±¬å‘½å®šå½©å¦</h2>
                
                <div class="loading-container hidden" id="rec-loading-spinner">
                    <div class="loader"></div>
                    <div class="loading-text">AI æ­£åœ¨ç‚ºä½ æŒ‘é¸æœ€é©åˆçš„å½©å¦...</div>
                </div>

                <div id="recommendations-list">
                    <!-- æ¨è–¦é …ç›®æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
                </div>
            </div>
        </div>

        <!-- ==================== æœé£¾é£¾å“åˆ†é  ==================== -->
        <div id="fashion-tab-content" class="tab-content hidden">
            
            <!-- ç©¿æ­è‰²å½©æŒ‡å— -->
            <div class="card">
                <h2 style="font-size: 18px; margin-top: 0;">ğŸ¨ å°ˆå±¬ç©¿æ­è‰²å½©æŒ‡å—</h2>
                
                <div class="loading-container hidden" id="fashion-guide-spinner">
                    <div class="loader" style="border-top-color: #9BACA3;"></div>
                    <div class="loading-text">AI æ­£åœ¨ç‚ºä½ ç”Ÿæˆè‰²å½©æ­é…æŒ‡å—...</div>
                </div>

                <div id="fashion-guide-content" class="hidden">
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-main);">âœ… æœ€é©åˆä½ çš„æœè£è‰²ç³»ï¼š</div>
                        <div id="fashion-best-colors"></div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #B47A7A;">âŒ å»ºè­°é¿é–‹çš„æœè£è‰²ï¼š</div>
                        <div id="fashion-worst-colors"></div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #C19A6B;">ğŸ’ æ¨è–¦é£¾å“æè³ªï¼š</div>
                        <p id="fashion-jewelry" class="result-text" style="background: #FCFAFA; padding: 10px; border-radius: 8px;"></p>
                    </div>
                    <div>
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--primary);">ğŸ‘— é¢¨æ ¼ç¸½çµï¼š</div>
                        <p id="fashion-summary" class="result-text"></p>
                    </div>
                </div>
            </div>

            <!-- Uniqlo / GU å°‹å¯¶å€ -->
            <div class="card">
                <h2 style="font-size: 18px; margin-top: 0;">ğŸ›ï¸ Uniqlo & GU å°ˆå±¬æ¨è–¦</h2>
                <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">è®“ AI å¾åœ‹æ°‘å“ç‰Œä¸­ï¼Œç‚ºä½ æŒ‘é¸æœ€è¥¯æ‰˜ä½ å­£å‹çš„ç¥ä»™å–®å“èˆ‡å°ˆå±¬è‰²è™Ÿï¼</p>
                
                <div class="form-group">
                    <label>æƒ³æ‰¾å“ªé¡å–®å“ï¼Ÿ</label>
                    <select id="fashion-category-select" style="margin-bottom: 12px;">
                        <option value="ä¸Šè¡£ (Tæ¤ / è¥¯è¡« / é‡ç¹”è¡« / æ¯›è¡£)">ğŸ‘• ä¸Šè¡£ (Tæ¤ / è¥¯è¡« / é‡ç¹”è¡« / æ¯›è¡£)</option>
                        <option value="ä¸‹èº« (è¤²å­ / è£™å­)">ğŸ‘– ä¸‹èº« (è¤²å­ / è£™å­)</option>
                        <option value="å¤–å¥— (å¤¾å…‹ / å¤§è¡£ / è¥¿è£)">ğŸ§¥ å¤–å¥— (å¤¾å…‹ / å¤§è¡£ / è¥¿è£)</option>
                        <option value="æ´‹è£ / é€£èº«è£™">ğŸ‘— æ´‹è£ / é€£èº«è£™</option>
                        <option value="é…ä»¶ (åŒ…åŒ… / åœå·¾ / å¸½å­)">ğŸ§£ é…ä»¶ (åŒ…åŒ… / åœå·¾ / å¸½å­)</option>
                    </select>
                    
                    <label>é¸æ“‡å“ç‰Œ</label>
                    <select id="fashion-brand-select">
                        <option value="Uniqlo & GU çš†å¯">Uniqlo & GU çš†å¯</option>
                        <option value="Uniqlo">Uniqlo</option>
                        <option value="GU">GU</option>
                    </select>
                </div>
                <button class="primary-btn" id="analyze-fashion-brand-btn" onclick="analyzeFashionBrand()" style="background-color: #8B9BAA;">æœå°‹é©åˆæˆ‘çš„æ¬¾å¼èˆ‡é¡è‰²</button>

                <div class="loading-container hidden" id="fashion-brand-loading-spinner">
                    <div class="loader" style="border-top-color: #8B9BAA;"></div>
                    <div class="loading-text">AI æ­£åœ¨ç‚ºä½ é…å° Uniqlo / GU ç†±é–€å–®å“...</div>
                </div>

                <div id="fashion-brand-result-list" style="margin-top: 16px;">
                    <!-- å“ç‰Œæ¨è–¦é …ç›®æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
                </div>
            </div>

            <!-- æœé£¾å–®å“åˆ†æ -->
            <div class="card">
                <h2 style="font-size: 18px; margin-top: 0;">ğŸ‘š é€™ä»¶è¡£æœ/é£¾å“é©åˆæˆ‘å—ï¼Ÿ</h2>
                <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">é˜²çˆ¬èŸ²ç¶²ç«™è®€ä¸åˆ°ï¼Ÿç›´æ¥æˆªåœ–ä¸Šå‚³äº¤çµ¦ AI å¹«ä½ è‚‰çœ¼é‘‘å®šï¼</p>
                
                <!-- åœ–ç‰‡ä¸Šå‚³å€ -->
                <div class="upload-buttons">
                    <label class="upload-btn">
                        ğŸ“¸ æ‹æ”å–®å“
                        <input type="file" class="hidden-file-input" accept="image/*" capture="environment" onchange="previewFashionImage(event)">
                    </label>
                    <label class="upload-btn">
                        ğŸ–¼ï¸ å¾ç›¸ç°¿æˆªåœ–
                        <input type="file" class="hidden-file-input" accept="image/*" onchange="previewFashionImage(event)">
                    </label>
                </div>

                <div id="fashion-photo-preview-container" class="hidden" style="position: relative; text-align: center; margin-bottom: 16px;">
                    <img id="fashion-photo-preview" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid var(--border-color);">
                    <button class="clear-btn" onclick="clearFashionImage()" style="position: absolute; top: 5px; right: 5px; background: rgba(255,255,255,0.8); border-radius: 50%;">âœ–</button>
                </div>

                <div style="text-align: center; color: #B0A1A4; font-size: 13px; margin-bottom: 12px;">â€” æˆ–ä½¿ç”¨æ–‡å­— / ç¶²å€ â€”</div>

                <div class="form-group">
                    <div class="input-wrapper">
                        <input type="text" id="fashion-input" class="input-with-clear" placeholder="è²¼ä¸Šç¶²è³¼é€£çµæˆ–è¼¸å…¥æœè£é¡è‰²æè³ª">
                        <button class="clear-btn" onclick="clearInput('fashion-input')">âœ–</button>
                    </div>
                </div>
                <button class="primary-btn" id="analyze-fashion-btn" onclick="analyzeFashionItem()">é–‹å§‹åˆ†æ</button>

                <div class="loading-container hidden" id="fashion-loading-spinner">
                    <div class="loader"></div>
                    <div class="loading-text">AI æ­£åœ¨åˆ†ææœé£¾è‰²å½©èˆ‡æè³ª...</div>
                </div>

                <div class="result-box hidden" id="fashion-result-container">
                    <div class="result-score" id="fashion-result-score">-- åˆ†</div>
                    <div class="result-title" id="fashion-result-summary">ç©¿æ­ç¸½çµ</div>
                    <p class="result-text" id="fashion-result-reason">åˆ†æåŸå› ...</p>
                </div>
            </div>

        </div>

    </div>

    <!-- é‡è¨­ API é‡‘é‘°æŒ‰éˆ• -->
    <div style="text-align: center; margin-top: 30px; margin-bottom: 30px;" id="reset-key-container" class="hidden">
        <button onclick="resetApiKey()" style="background: none; color: #999; border: 1px solid #ddd; width: auto; font-size: 13px; padding: 6px 16px; border-radius: 20px; cursor: pointer;">ğŸ”‘ é‡æ–°è¨­å®š API é‡‘é‘° / æ¸…é™¤è³‡æ–™</button>
    </div>

</div>

<script>
    // --- ç³»çµ±ç‹€æ…‹ç®¡ç† ---
    const STATE = {
        apiKey: localStorage.getItem('gemini_api_key') || '',
        season: localStorage.getItem('user_season') || ''
    };

    let currentImageFile = null;
    let currentFashionImageFile = null;

    // --- ã€é˜² 429 ç¥å™¨ã€‘é€²éš API é‡è©¦æ©Ÿåˆ¶ (Exponential Backoff) ---
    async function fetchWithRetry(url, options) {
        // é‡åˆ° 429 æ™‚çš„é€€é¿ç­‰å¾…æ™‚é–“ï¼š1ç§’, 2ç§’, 4ç§’, 8ç§’, 16ç§’ (å…±é‡è©¦ 5 æ¬¡)
        const delays = [1000, 2000, 4000, 8000, 16000];
        let lastError;

        for (let i = 0; i <= delays.length; i++) {
            try {
                const response = await fetch(url, options);

                // å¦‚æœç™¼ç”Ÿ 429ï¼Œä¸»å‹•æ‹‹å‡ºä¾‹å¤–è®“å¤–å±¤æ•æ‰é‡è©¦
                if (response.status === 429) {
                    throw new Error("RateLimit");
                }
                
                // è™•ç†å…¶ä»–ä¸€èˆ¬éŒ¯èª¤ (ä¾‹å¦‚ 400 API Key éŒ¯èª¤)
                if (!response.ok) {
                    throw await handleApiError(response);
                }

                // æˆåŠŸå‰‡å›å‚³
                return response;
            } catch (error) {
                lastError = error;
                // å¦‚æœæ˜¯ RateLimitï¼Œä¸”é‚„æœ‰é‡è©¦æ¬¡æ•¸ï¼Œå°±ç­‰å¾…ä¸€æ®µæ™‚é–“å¾Œå†è©¦
                if (error.message === "RateLimit" && i < delays.length) {
                    console.log(`[ç³»çµ±æç¤º] åµæ¸¬åˆ°é »ç‡é™åˆ¶ (429)ï¼Œå°‡æ–¼ ${delays[i]/1000} ç§’å¾Œè‡ªå‹•é‡è©¦...`);
                    await new Promise(resolve => setTimeout(resolve, delays[i]));
                } else {
                    // å¦‚æœä¸æ˜¯ 429ï¼Œæˆ–æ˜¯ 429 å·²ç¶“é‡è©¦åˆ°æ¥µé™äº†ï¼Œå°±æ‹‹å‡ºæœ€çµ‚éŒ¯èª¤çµ¦ä½¿ç”¨è€…çœ‹
                    if (error.message === "RateLimit") {
                        throw new Error("ä¼ºæœå™¨æ¥µåº¦ç¹å¿™ (HTTP 429) âŒ\nç³»çµ±å·²è‡ªå‹•é‡è©¦å¤šæ¬¡ï¼Œè«‹æ‚¨å…ˆå–å£æ°´ï¼Œä¼‘æ¯ä¸€åˆ†é˜å¾Œå†é»æ“ŠæŒ‰éˆ•ã€‚");
                    }
                    throw error;
                }
            }
        }
    }

    // --- å…±ç”¨çš„éŒ¯èª¤è™•ç†å‡½æ•¸ ---
    async function handleApiError(response) {
        let errorMsg = `HTTP ç‹€æ…‹ç¢¼: ${response.status}`;
        try {
            const errData = await response.json();
            if (errData.error && errData.error.message) {
                if (errData.error.message.includes("API key not valid")) {
                    return new Error("æ‚¨è¼¸å…¥çš„ API Key ç„¡æ•ˆæˆ–æ ¼å¼ä¸æ­£ç¢º âŒ\nè«‹é»æ“Šé é¢åº•éƒ¨çš„ã€Œé‡æ–°è¨­å®š API é‡‘é‘°ã€æŒ‰éˆ•æ›´æ–°ã€‚");
                }
                errorMsg += `\n\n[ä¼ºæœå™¨å›å‚³ç´°ç¯€]:\n${errData.error.message}`;
            }
        } catch(e) {}
        return new Error(errorMsg);
    }

    // --- é é¢åˆå§‹åŒ– ---
    function init() {
        if (!STATE.apiKey) {
            document.getElementById('api-key-section').classList.remove('hidden');
        } else {
            document.getElementById('reset-key-container').classList.remove('hidden');
            if (!STATE.season) {
                document.getElementById('season-section').classList.remove('hidden');
            } else {
                showMainContent();
            }
        }
    }

    // --- æ¸…é™¤è¼¸å…¥æ¡†å…§å®¹ ---
    function clearInput(inputId) {
        const el = document.getElementById(inputId);
        if(el) {
            el.value = '';
            el.focus();
        }
    }

    // --- åˆ†é åˆ‡æ›é‚è¼¯ ---
    function switchTab(tabId) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        
        if(tabId === 'makeup') {
            document.querySelectorAll('.tab')[0].classList.add('active');
            document.getElementById('makeup-tab-content').classList.remove('hidden');
        } else {
            document.querySelectorAll('.tab')[1].classList.add('active');
            document.getElementById('fashion-tab-content').classList.remove('hidden');
            fetchFashionGuide();
        }
    }

    // --- å„²å­˜ API Key ---
    function saveApiKey() {
        const keyInput = document.getElementById('api-key-input').value.trim();
        if (!keyInput) {
            alert('è«‹è¼¸å…¥ API Key');
            return;
        }
        STATE.apiKey = keyInput;
        localStorage.setItem('gemini_api_key', keyInput);
        document.getElementById('api-key-section').classList.add('hidden');
        document.getElementById('reset-key-container').classList.remove('hidden');
        
        if (!STATE.season) {
            document.getElementById('season-section').classList.remove('hidden');
        } else {
            showMainContent();
        }
    }

    // --- é‡è¨­ API Key ---
    function resetApiKey() {
        if(confirm('ç¢ºå®šè¦æ¸…é™¤å„²å­˜çš„ API é‡‘é‘°èˆ‡å€‹äººå­£å‹è¨­å®šå—ï¼Ÿ')) {
            localStorage.removeItem('gemini_api_key');
            localStorage.removeItem('user_season');
            localStorage.removeItem(`recs_${STATE.season}`);
            localStorage.removeItem(`fashion_${STATE.season}`);
            STATE.apiKey = ''; 
            location.reload();
        }
    }

    // --- é è¦½èˆ‡æ¸…é™¤åœ–ç‰‡é‚è¼¯ ---
    function previewImage(event) {
        const file = event.target.files[0];
        if (!file) return;
        currentImageFile = file;
        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('photo-preview').src = e.target.result;
            document.getElementById('photo-preview-container').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }

    function previewFashionImage(event) {
        const file = event.target.files[0];
        if (!file) return;
        currentFashionImageFile = file;
        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('fashion-photo-preview').src = e.target.result;
            document.getElementById('fashion-photo-preview-container').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }

    function clearFashionImage() {
        currentFashionImageFile = null;
        document.getElementById('fashion-photo-preview').src = '';
        document.getElementById('fashion-photo-preview-container').classList.add('hidden');
        document.querySelectorAll('#fashion-tab-content .hidden-file-input').forEach(input => input.value = '');
    }

    // --- åœ–ç‰‡å£“ç¸®å‡½æ•¸ ---
    function compress(file) {
        return new Promise(resolve => {
            const r = new FileReader();
            r.readAsDataURL(file);
            r.onload = e => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const cvs = document.createElement('canvas');
                    const max = 1024;
                    let w = img.width, h = img.height;
                    if(w > max) { h *= max/w; w = max; }
                    cvs.width = w; cvs.height = h;
                    cvs.getContext('2d').drawImage(img,0,0,w,h);
                    resolve(cvs.toDataURL('image/jpeg', 0.8).split(',')[1]);
                };
            };
        });
    }

    // --- å‘¼å« Gemini Vision API åˆ†æç…§ç‰‡ ---
    async function analyzeSeasonFromPhoto() {
        if (!currentImageFile) {
            alert('è«‹å…ˆä¸Šå‚³æˆ–æ‹æ”ç…§ç‰‡ï¼');
            return;
        }

        const analyzeBtn = document.getElementById('analyze-photo-btn');
        const loadingSpinner = document.getElementById('season-loading-spinner');
        
        analyzeBtn.disabled = true;
        loadingSpinner.classList.remove('hidden');

        try {
            const base64Data = await compress(currentImageFile);
            const prompt = `
                ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„éŸ“åœ‹ Personal Color è‰²å½©åˆ†æå¸«ã€‚
                è«‹ä»”ç´°åˆ†æé€™å¼µäººåƒç…§ç‰‡ä¸­äººç‰©çš„è†šè‰²åŸºèª¿ï¼ˆå†·æš–ï¼‰ã€åŸç”Ÿé«®è‰²å’Œç³å­”è‰²ï¼Œä¸¦åˆ¤æ–·ä»–å±¬æ–¼å“ªä¸€å€‹å››å­£è‰²å½©å‹åˆ¥ã€‚
                å¿…é ˆåš´æ ¼ä»¥ JSON æ ¼å¼å›å‚³ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
                {
                    "season": "è«‹å›å‚³ä¸‹åˆ—å­—ä¸²ä¸­çš„ã€Œå®Œå…¨åŒ¹é…ã€å€¼ä¹‹ä¸€ï¼šæ˜¥å­£æ·ºè‰²å‹ (Light Spring), æ˜¥å­£æš–è‰²å‹ (Warm Spring), æ˜¥å­£æ·¨è‰²å‹ (Clear Spring), å¤å­£æ·ºè‰²å‹ (Light Summer), å¤å­£å†·è‰²å‹ (Cool Summer), å¤å­£æŸ”å’Œå‹ (Soft Summer), ç§‹å­£æŸ”å’Œå‹ (Soft Autumn), ç§‹å­£æš–è‰²å‹ (Warm Autumn), ç§‹å­£æ·±è‰²å‹ (Deep Autumn), å†¬å­£æ·¨è‰²å‹ (Clear Winter), å†¬å­£å†·è‰²å‹ (Cool Winter), å†¬å­£æ·±è‰²å‹ (Deep Winter)",
                    "reason": "è©³ç´°èªªæ˜ä½ çš„åˆ¤æ–·åŸå› ï¼ˆç´„ 50 å­—å…§ï¼‰"
                }
                è«‹åªå›å‚³ JSON å­—ä¸²ã€‚
            `;

            const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${STATE.apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ role: "user", parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64Data } }] }],
                    generationConfig: { temperature: 0.2, responseMimeType: "application/json" }
                })
            });

            const data = await response.json();
            const resultJson = JSON.parse(data.candidates[0].content.parts[0].text);

            const seasonSelect = document.getElementById('season-select');
            let matched = false;
            for (let i = 0; i < seasonSelect.options.length; i++) {
                if (seasonSelect.options[i].value === resultJson.season) {
                    seasonSelect.selectedIndex = i;
                    matched = true;
                    break;
                }
            }

            if (matched) {
                alert(`âœ… AI åˆ†æå®Œæˆï¼\n\nç³»çµ±åˆ¤å®šä½ æ˜¯ï¼š${resultJson.season}\n\nğŸ“ è¨ºæ–·å ±å‘Šï¼š${resultJson.reason}\n\n(å·²è‡ªå‹•ç‚ºæ‚¨é¸å–å¥½å­£å‹ï¼Œè«‹é»æ“Šã€Œè¨­å®šå®Œæˆã€ç¹¼çºŒ)`);
            } else {
                alert(`âœ… AI åˆ†æå®Œæˆï¼\n\nç³»çµ±åˆ¤å®šä½ æ˜¯ï¼š${resultJson.season}\nğŸ“ è¨ºæ–·å ±å‘Šï¼š${resultJson.reason}\n\n(è«‹åƒè€ƒæ­¤å»ºè­°ï¼Œæ‰‹å‹•åœ¨ä¸‹æ–¹é¸å–®é¸æ“‡æœ€æ¥è¿‘çš„å­£å‹)`);
            }
        } catch (error) {
            alert(`${error.message}`);
        } finally {
            analyzeBtn.disabled = false;
            loadingSpinner.classList.add('hidden');
        }
    }

    // --- å„²å­˜å­£å‹ ---
    function saveSeason() {
        const seasonSelect = document.getElementById('season-select').value;
        if (!seasonSelect) {
            alert('è«‹é¸æ“‡ä¸€å€‹å­£å‹ï¼');
            return;
        }
        STATE.season = seasonSelect;
        localStorage.setItem('user_season', seasonSelect);
        document.getElementById('season-section').classList.add('hidden');
        showMainContent();
    }

    // --- é‡æ–°ç·¨è¼¯å­£å‹ ---
    function editSeason() {
        document.getElementById('main-content-area').classList.add('hidden');
        document.getElementById('season-section').classList.remove('hidden');
        document.getElementById('season-select').value = STATE.season;
    }

    // --- é¡¯ç¤ºä¸»è¦åˆ†æå€ ---
    function showMainContent() {
        document.getElementById('main-content-area').classList.remove('hidden');
        document.getElementById('current-season-tag').textContent = `âœ¨ æˆ‘çš„å­£å‹ï¼š${STATE.season}`;
        switchTab('makeup');
        fetchRecommendations();
    }

    // ==================== å½©å¦åŠŸèƒ½ ====================

    async function analyzeProduct() {
        const productInput = document.getElementById('product-input').value.trim();
        if (!productInput) {
            alert('è«‹è¼¸å…¥å½©å¦å“ç‰Œèˆ‡è‰²è™Ÿï¼Œæˆ–è²¼ä¸Šç¶²å€ï¼');
            return;
        }

        const analyzeBtn = document.getElementById('analyze-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const resultContainer = document.getElementById('result-container');
        
        analyzeBtn.disabled = true;
        loadingSpinner.classList.remove('hidden');
        resultContainer.classList.add('hidden');

        try {
            const prompt = `
                ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„éŸ“åœ‹ Personal Color è‰²å½©åˆ†æå¸«ã€‚æˆ‘çš„å­£å‹æ˜¯ï¼šã€Œ${STATE.season}ã€ã€‚
                è«‹å¹«æˆ‘åˆ†æé€™æ¬¾å½©å¦ç”¢å“ï¼šã€Œ${productInput}ã€ã€‚
                å¿…é ˆåš´æ ¼ä»¥ JSON æ ¼å¼å›å‚³ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
                {
                    "score": æ•¸å­— (1-100ï¼Œè¡¨ç¤ºé©åˆç¨‹åº¦),
                    "summary": "ä¸€å¥è©±ç¸½çµè©²ç”¢å“çš„çœŸå¯¦é¡è‰²ï¼Œä¾‹å¦‚ï¼šå¸¶ç°èª¿çš„ä¹¾ç‡¥ç«ç‘°è‰²",
                    "reason": "è©³ç´°èªªæ˜ç‚ºä»€éº¼é©åˆæˆ–ä¸é©åˆæˆ‘ï¼ˆç´„50-80å­—ï¼‰"
                }
                è«‹åªå›å‚³ JSON å­—ä¸²ã€‚
            `;

            const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${STATE.apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.2, responseMimeType: "application/json" }
                })
            });

            const data = await response.json();
            const resultJson = JSON.parse(data.candidates[0].content.parts[0].text);

            document.getElementById('result-score').textContent = `${resultJson.score} åˆ†`;
            document.getElementById('result-score').style.color = resultJson.score >= 80 ? '#7B8D82' : (resultJson.score >= 60 ? '#C19A6B' : '#B47A7A');
            document.getElementById('result-summary').textContent = resultJson.summary;
            document.getElementById('result-reason').textContent = resultJson.reason;
            resultContainer.classList.remove('hidden');
        } catch (error) {
            alert(`${error.message}`);
        } finally {
            analyzeBtn.disabled = false;
            loadingSpinner.classList.add('hidden');
        }
    }

    async function analyzeBrand() {
        const brandInput = document.getElementById('brand-input').value.trim() || 'ç†±é–€å°ˆæ«ƒæˆ–é–‹æ¶å“ç‰Œ';
        const categoryInput = document.getElementById('makeup-category-select').value;
        const analyzeBtn = document.getElementById('analyze-brand-btn');
        const loadingSpinner = document.getElementById('brand-loading-spinner');
        const resultList = document.getElementById('brand-result-list');
        
        analyzeBtn.disabled = true;
        loadingSpinner.classList.remove('hidden');
        resultList.innerHTML = '';

        try {
            const prompt = `
                ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ Personal Color è‰²å½©åˆ†æå¸«ã€‚æˆ‘çš„å­£å‹æ˜¯ï¼šã€Œ${STATE.season}ã€ã€‚
                æˆ‘ç¾åœ¨æƒ³å°‹æ‰¾ã€Œ${brandInput}ã€é€™å€‹å“ç‰Œï¼ˆæˆ–ç›¸é—œï¼‰çš„ã€Œ${categoryInput}ã€ç”¢å“ã€‚
                è«‹ç‰¹åˆ¥åƒè€ƒæ—¥æœ¬ @Cosme ä»¥åŠéŸ“åœ‹ Olive Young ç†±é–€æ¦œå–®ï¼Œä¸¦æ¶µè“‹å°ç£å°ˆæ«ƒå“ç‰Œã€‚
                åš´é¸ 3 åˆ° 5 æ¬¾ã€Œæœ€é©åˆã€æˆ‘é€™å€‹å­£å‹çš„ç”¢å“ï¼ˆåŒ…å«æ˜ç¢ºè‰²è™Ÿï¼‰ã€‚
                ä»¥ JSON é™£åˆ—å›å‚³ï¼š
                [{"brand": "å“ç‰Œ", "product": "ç”¢å“åèˆ‡è‰²è™Ÿ", "type": "é¡åˆ¥", "reason": "æ¨è–¦åŸå› "}]
                è«‹åªå›å‚³ JSON é™£åˆ—ã€‚
            `;

            const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${STATE.apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.3, responseMimeType: "application/json" }
                })
            });

            const data = await response.json();
            const resultJson = JSON.parse(data.candidates[0].content.parts[0].text);

            resultList.innerHTML = resultJson.map(item => `
                <div class="rec-item">
                    <div class="rec-header">
                        <span class="rec-brand">${item.brand}</span>
                        <span class="rec-type-tag" style="background-color: #E9ECEF; color: #627585;">${item.type}</span>
                    </div>
                    <div class="rec-product">${item.product}</div>
                    <p class="rec-reason">${item.reason}</p>
                </div>
            `).join('');
        } catch (error) {
            resultList.innerHTML = `<div class="error-message">${error.message.replace(/\n/g, '<br>')}</div>`;
        } finally {
            analyzeBtn.disabled = false;
            loadingSpinner.classList.add('hidden');
        }
    }

    async function fetchRecommendations() {
        const recList = document.getElementById('recommendations-list');
        const loadingSpinner = document.getElementById('rec-loading-spinner');
        const cacheKey = `recs_${STATE.season}`;
        
        if (localStorage.getItem(cacheKey)) {
            renderRecommendations(JSON.parse(localStorage.getItem(cacheKey)));
            return;
        }

        recList.innerHTML = '';
        loadingSpinner.classList.remove('hidden');

        try {
            const prompt = `
                ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ Personal Color è‰²å½©åˆ†æå¸«ã€‚æˆ‘çš„å­£å‹æ˜¯ï¼šã€Œ${STATE.season}ã€ã€‚
                è«‹å¼·çƒˆåƒè€ƒæ—¥æœ¬ @Cosme åŠéŸ“åœ‹ Olive Young ç†±é–€æ¦œå–®ï¼Œæ¶µè“‹å°ç£çŸ¥åå°ˆæ«ƒå“ç‰Œã€‚
                ç‚ºæˆ‘æ¨è–¦ 3 æ¬¾ã€Œçµ•å°é©åˆã€æˆ‘çš„å½©å¦ç”¢å“ã€‚
                ä»¥ JSON é™£åˆ—å›å‚³ï¼š[{"brand": "å“ç‰Œ", "product": "ç”¢å“åèˆ‡è‰²è™Ÿ", "type": "é¡åˆ¥", "reason": "æ¨è–¦åŸå› "}]
                è«‹åªå›å‚³ JSON é™£åˆ—ã€‚
            `;

            const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${STATE.apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.4, responseMimeType: "application/json" }
                })
            });

            const data = await response.json();
            const resultJson = JSON.parse(data.candidates[0].content.parts[0].text);
            localStorage.setItem(cacheKey, JSON.stringify(resultJson));
            renderRecommendations(resultJson);
        } catch (error) {
            recList.innerHTML = `<div class="error-message">è¼‰å…¥æ¨è–¦æ¸…å–®å¤±æ•—ï¼š<br>${error.message.replace(/\n/g, '<br>')}</div>`;
        } finally {
            loadingSpinner.classList.add('hidden');
        }
    }

    function renderRecommendations(items) {
        document.getElementById('recommendations-list').innerHTML = items.map(item => `
            <div class="rec-item">
                <div class="rec-header">
                    <span class="rec-brand">${item.brand}</span>
                    <span class="rec-type-tag">${item.type}</span>
                </div>
                <div class="rec-product">${item.product}</div>
                <p class="rec-reason">${item.reason}</p>
            </div>
        `).join('');
    }

    // ==================== æœé£¾é£¾å“åŠŸèƒ½ ====================

    async function fetchFashionGuide() {
        const guideContent = document.getElementById('fashion-guide-content');
        const loadingSpinner = document.getElementById('fashion-guide-spinner');
        const cacheKey = `fashion_${STATE.season}`;
        
        if (localStorage.getItem(cacheKey)) {
            renderFashionGuide(JSON.parse(localStorage.getItem(cacheKey)));
            return;
        }

        guideContent.classList.add('hidden');
        loadingSpinner.classList.remove('hidden');

        try {
            const prompt = `
                ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ Personal Color ç©¿æ­é¡§å•ã€‚æˆ‘çš„å­£å‹æ˜¯ï¼šã€Œ${STATE.season}ã€ã€‚
                è«‹ç‚ºæˆ‘æ¨è–¦é©åˆçš„æœè£é¡è‰²èˆ‡é£¾å“æè³ªã€‚
                å¿…é ˆåš´æ ¼ä»¥ JSON æ ¼å¼å›å‚³ï¼š{"bestColors": ["è‰²1", "è‰²2"], "worstColors": ["é›·è‰²1"], "jewelry": "é£¾å“å»ºè­°", "summary": "ç¸½çµ"}
                è«‹åªå›å‚³ JSON å­—ä¸²ã€‚
            `;

            const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${STATE.apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.3, responseMimeType: "application/json" }
                })
            });

            const data = await response.json();
            const resultJson = JSON.parse(data.candidates[0].content.parts[0].text);
            localStorage.setItem(cacheKey, JSON.stringify(resultJson));
            renderFashionGuide(resultJson);
        } catch (error) {
            guideContent.innerHTML = `<div class="error-message">ç„¡æ³•è¼‰å…¥æŒ‡å—ï¼š<br>${error.message.replace(/\n/g, '<br>')}</div>`;
            guideContent.classList.remove('hidden');
        } finally {
            loadingSpinner.classList.add('hidden');
        }
    }

    function renderFashionGuide(data) {
        document.getElementById('fashion-best-colors').innerHTML = data.bestColors.map(c => `<span class="fashion-tag" style="background-color: #E2E8E4; color: #4A5D52;">${c}</span>`).join('');
        document.getElementById('fashion-worst-colors').innerHTML = data.worstColors.map(c => `<span class="fashion-tag" style="background-color: #F4E8E8; color: #8C5555;">${c}</span>`).join('');
        document.getElementById('fashion-jewelry').textContent = data.jewelry;
        document.getElementById('fashion-summary').textContent = data.summary;
        document.getElementById('fashion-guide-content').classList.remove('hidden');
    }

    async function analyzeFashionBrand() {
        const categoryInput = document.getElementById('fashion-category-select').value;
        const brandInput = document.getElementById('fashion-brand-select').value;
        const analyzeBtn = document.getElementById('analyze-fashion-brand-btn');
        const loadingSpinner = document.getElementById('fashion-brand-loading-spinner');
        const resultList = document.getElementById('fashion-brand-result-list');
        
        analyzeBtn.disabled = true;
        loadingSpinner.classList.remove('hidden');
        resultList.innerHTML = '';

        try {
            const prompt = `
                ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ Personal Color ç©¿æ­é¡§å•ã€‚æˆ‘çš„å­£å‹æ˜¯ï¼šã€Œ${STATE.season}ã€ã€‚
                æˆ‘æƒ³å°‹æ‰¾ã€Œ${brandInput}ã€çš„ã€Œ${categoryInput}ã€ã€‚
                è«‹æ¨è–¦ 3 æ¬¾ç›®å‰æˆ–ç¶“å…¸ç†±è³£çš„å–®å“ã€‚è«‹å‹™å¿…æŒ‘é¸æœ€é©åˆæˆ‘å­£å‹çš„å…·é«”é¡è‰²ç·¨è™Ÿèˆ‡æ¬¾å¼ã€‚
                ä»¥ JSON é™£åˆ—å›å‚³ï¼š[{"brand": "Uniqlo æˆ– GU", "product": "ç”¢å“åç¨±", "color": "é¡è‰²ç·¨è™Ÿæˆ–åç¨±", "reason": "æ¨è–¦åŸå› ", "keyword": "ç”¨æ–¼å®˜ç¶²æœå°‹çš„ç°¡çŸ­é—œéµå­—"}]
                è«‹åªå›å‚³ JSON é™£åˆ—ã€‚
            `;

            const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${STATE.apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.3, responseMimeType: "application/json" }
                })
            });

            const data = await response.json();
            const resultJson = JSON.parse(data.candidates[0].content.parts[0].text);

            resultList.innerHTML = resultJson.map(item => {
                const searchUrl = item.brand.toUpperCase().includes('GU') 
                    ? `https://www.gu-global.com/tw/zh_TW/search.html?q=${encodeURIComponent(item.keyword)}`
                    : `https://www.uniqlo.com/tw/zh_TW/search.html?q=${encodeURIComponent(item.keyword)}`;
                return `
                <div class="rec-item">
                    <div class="rec-header">
                        <span class="rec-brand">${item.brand}</span>
                        <span class="rec-type-tag" style="background-color: #E9ECEF; color: #627585;">æ¨è–¦è‰²ï¼š${item.color}</span>
                    </div>
                    <div class="rec-product">${item.product}</div>
                    <p class="rec-reason" style="margin-bottom: 12px;">${item.reason}</p>
                    <a href="${searchUrl}" target="_blank" style="display: inline-flex; align-items: center; font-size: 13px; color: #8B9BAA; text-decoration: none; border: 1px solid #8B9BAA; padding: 6px 14px; border-radius: 20px; transition: all 0.2s; font-weight: 500;" onmouseover="this.style.backgroundColor='#8B9BAA'; this.style.color='#FFF'" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#8B9BAA'">
                        <span style="margin-right: 4px;">ğŸ”</span> å‰å¾€å®˜ç¶²æœå°‹æ­¤å–®å“
                    </a>
                </div>`;
            }).join('');
        } catch (error) {
            resultList.innerHTML = `<div class="error-message">${error.message.replace(/\n/g, '<br>')}</div>`;
        } finally {
            analyzeBtn.disabled = false;
            loadingSpinner.classList.add('hidden');
        }
    }

    async function analyzeFashionItem() {
        const fashionInput = document.getElementById('fashion-input').value.trim();
        if (!fashionInput && !currentFashionImageFile) {
            alert('è«‹ä¸Šå‚³æœé£¾åœ–ç‰‡ï¼Œæˆ–æ˜¯è¼¸å…¥æœé£¾æè¿° / ç¶²å€ï¼');
            return;
        }

        const analyzeBtn = document.getElementById('analyze-fashion-btn');
        const loadingSpinner = document.getElementById('fashion-loading-spinner');
        const resultContainer = document.getElementById('fashion-result-container');
        
        analyzeBtn.disabled = true;
        loadingSpinner.classList.remove('hidden');
        resultContainer.classList.add('hidden');

        try {
            let parts = [];
            let promptText = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ Personal Color ç©¿æ­é¡§å•ã€‚æˆ‘çš„å­£å‹æ˜¯ï¼šã€Œ${STATE.season}ã€ã€‚\n`;
            if (fashionInput && currentFashionImageFile) {
                promptText += `è«‹å¹«æˆ‘åˆ†æé€™å¼µåœ–ç‰‡ä¸­çš„æœè£/é£¾å“ï¼Œä»¥åŠåƒè€ƒé€™æ®µè£œå……æè¿°/ç¶²å€ï¼šã€Œ${fashionInput}ã€ã€‚\n`;
            } else if (currentFashionImageFile) {
                promptText += `è«‹å¹«æˆ‘åˆ†æé€™å¼µåœ–ç‰‡ä¸­çš„æœè£/é£¾å“ã€‚\n`;
            } else {
                promptText += `è«‹å¹«æˆ‘åˆ†æé€™æ¬¾æœè£æˆ–é£¾å“ï¼šã€Œ${fashionInput}ã€ã€‚\n`;
            }
            promptText += `
                åˆ¤æ–·é€™æ¬¾å–®å“çš„é¡è‰²èˆ‡æè³ªï¼Œä¸¦è©•ä¼°å®ƒæ˜¯å¦é©åˆæˆ‘çš„å­£å‹ã€‚
                å¿…é ˆåš´æ ¼ä»¥ JSON æ ¼å¼å›å‚³ï¼š{"score": æ•¸å­—, "summary": "ç¸½çµ", "reason": "åŸå› "}
                è«‹åªå›å‚³ JSON å­—ä¸²ã€‚
            `;
            parts.push({ text: promptText });

            if (currentFashionImageFile) {
                parts.push({ inlineData: { mimeType: "image/jpeg", data: await compress(currentFashionImageFile) } });
            }

            const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${STATE.apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: parts }],
                    generationConfig: { temperature: 0.2, responseMimeType: "application/json" }
                })
            });

            const data = await response.json();
            const resultJson = JSON.parse(data.candidates[0].content.parts[0].text);

            document.getElementById('fashion-result-score').textContent = `${resultJson.score} åˆ†`;
            document.getElementById('fashion-result-score').style.color = resultJson.score >= 80 ? '#7B8D82' : (resultJson.score >= 60 ? '#C19A6B' : '#B47A7A');
            document.getElementById('fashion-result-summary').textContent = resultJson.summary;
            document.getElementById('fashion-result-reason').textContent = resultJson.reason;
            resultContainer.classList.remove('hidden');
        } catch (error) {
            alert(`${error.message}`);
        } finally {
            analyzeBtn.disabled = false;
            loadingSpinner.classList.add('hidden');
        }
    }

    init();
</script>
</body>
</html>
