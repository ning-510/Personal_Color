<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Personal Color å½©å¦é¡§å•</title>
    <style>
        :root {
            --primary: #A59395; /* è«è˜­è¿ªç…™ç²‰ç´« */
            --primary-hover: #8F7D7F; /* è¼ƒæ·±çš„ç…™ç²‰ç´« */
            --bg-color: #F4F1F1; /* æ¥µæ·ºçš„æš–ç°èƒŒæ™¯ */
            --text-main: #4A4344; /* æ·±æš–ç°æ–‡å­— */
            --text-muted: #807677; /* ä¸­æ€§æš–ç° */
            --card-bg: #FFFFFF;
            --border-color: #DCD7D7; /* æŸ”å’Œçš„é‚Šæ¡†è‰² */
            --radius: 16px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            overflow-x: hidden;
            width: 100%;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 480px;
            margin-top: 20px;
            box-sizing: border-box;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 24px;
            margin: 0 0 8px 0;
            color: var(--text-main);
        }

        .header p {
            font-size: 14px;
            color: var(--text-muted);
            margin: 0;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        input[type="text"], input[type="password"], select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            box-sizing: border-box;
            transition: border-color 0.2s;
            background-color: #FCFAFA;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            background-color: #FFFFFF;
        }

        button {
            width: 100%;
            padding: 14px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }

        button:hover {
            background-color: var(--primary-hover);
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            background-color: #D3CDCD;
            cursor: not-allowed;
        }

        .button-secondary {
            background-color: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border-color);
            margin-top: 10px;
        }

        .button-secondary:hover {
            background-color: #F0EDED;
        }

        .hidden {
            display: none !important;
        }

        /* é›™æŒ‰éˆ•ä¸Šå‚³å°ˆç”¨æ¨£å¼ */
        .upload-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .upload-btn {
            flex: 1;
            padding: 12px 0;
            background-color: #FFFFFF;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.2s;
            display: block;
        }
        
        .upload-btn:hover {
            background-color: #F9F9F9;
            border-color: var(--primary);
        }
        
        .hidden-file-input {
            display: none;
        }

        /* è¼‰å…¥å‹•ç•« */
        .loader {
            border: 3px solid #EBE6E6;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-container {
            text-align: center;
            padding: 20px 0;
        }

        .loading-text {
            margin-top: 10px;
            font-size: 14px;
            color: var(--text-muted);
        }

        /* çµæœå±•ç¤ºå€ */
        .result-box {
            background-color: #F6F3F3;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #EBE6E6;
        }

        .result-score {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
            text-align: center;
            margin-bottom: 10px;
        }

        .result-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #8B6D71;
        }

        .result-text {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 0;
            color: var(--text-main);
        }
        
        .tag {
            display: inline-block;
            background-color: #EBE6E6;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            color: #6D6364;
            margin-bottom: 16px;
        }

        /* æ¨è–¦æ¸…å–®å°ˆç”¨æ¨£å¼ */
        .rec-item {
            padding: 16px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .rec-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        .rec-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        .rec-brand {
            font-weight: bold;
            color: var(--primary);
            font-size: 14px;
        }
        .rec-type-tag {
            font-size: 11px;
            background-color: #F6F3F3;
            color: #8B6D71;
            padding: 2px 8px;
            border-radius: 12px;
        }
        .rec-product {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 6px;
        }
        .rec-reason {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.5;
            margin: 0;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Personal Color å½©å¦é¡§å•</h1>
        <p>è¼¸å…¥å•†å“ï¼ŒAI å³æ™‚åˆ†ææ˜¯å¦é©åˆä½ çš„å­£å‹</p>
    </div>

    <!-- å€å¡Š 1ï¼šAPI Key è¨­å®š (åƒ…é¦–æ¬¡é¡¯ç¤º) -->
    <div class="card" id="api-key-section">
        <div class="form-group">
            <label for="api-key-input">è«‹è¼¸å…¥é€šé—œå¯†ç¢¼ (API Key)</label>
            <input type="password" id="api-key-input" placeholder="è²¼ä¸Š Gemini API Key">
            <p style="font-size: 12px; color: #888; margin-top: 6px;">å¯†ç¢¼åƒ…å„²å­˜æ–¼æ‚¨çš„è¨­å‚™ä¸­ï¼Œç¢ºä¿å®‰å…¨ä¸”ä¸æœƒä¸Šå‚³è‡³ä¼ºæœå™¨ã€‚</p>
        </div>
        <button onclick="saveApiKey()">ç¢ºèªå„²å­˜</button>
    </div>

    <!-- å€å¡Š 2ï¼šå€‹äººè‰²å½©è¨­å®š (è¨­å®šéå¾Œå¯éš±è—) -->
    <div class="card hidden" id="season-section">
        <h2 style="font-size: 18px; margin-top: 0;">1. è¨­å®šä½ çš„å°ˆå±¬å­£å‹</h2>
        
        <!-- ç…§ç‰‡ä¸Šå‚³èˆ‡ AI åˆ†æå€å¡Š -->
        <div class="form-group" style="background-color: #FCFAFA; padding: 16px; border-radius: 12px; margin-bottom: 20px; border: 1px dashed var(--border-color);">
            <label style="color: var(--primary); font-size: 16px;">âœ¨ ç›¸æ©Ÿ / ç…§ç‰‡ AI æ¸¬è‰²</label>
            <p style="font-size: 13px; color: var(--text-muted); margin-top: 4px; margin-bottom: 12px;">è«‹åœ¨è‡ªç„¶å…‰ä¸‹æ‹æ”ç´ é¡ç…§ï¼Œä»¥ç²å¾—æœ€æº–ç¢ºçš„çµæœã€‚</p>
            
            <div class="upload-buttons">
                <label class="upload-btn">
                    ğŸ“¸ é–‹å•Ÿç›¸æ©Ÿ
                    <input type="file" class="hidden-file-input" accept="image/*" capture="user" onchange="previewImage(event)">
                </label>
                <label class="upload-btn">
                    ğŸ–¼ï¸ å¾ç›¸ç°¿é¸æ“‡
                    <input type="file" class="hidden-file-input" accept="image/*" onchange="previewImage(event)">
                </label>
            </div>
            
            <div id="photo-preview-container" class="hidden" style="text-align: center; margin-top: 12px;">
                <img id="photo-preview" style="max-width: 100%; max-height: 250px; border-radius: 8px; border: 1px solid var(--border-color);">
                <button id="analyze-photo-btn" onclick="analyzeSeasonFromPhoto()" style="margin-top: 12px; background-color: #9BACA3;">é–‹å§‹ AI æ¸¬è‰²</button>
            </div>
            
            <div class="loading-container hidden" id="season-loading-spinner">
                <div class="loader" style="border-top-color: #9BACA3;"></div>
                <div class="loading-text">AI æ­£åœ¨åˆ†æä½ çš„è†šè‰²åŸºå› ...</div>
            </div>
        </div>

        <div style="text-align: center; color: #B0A1A4; font-size: 13px; margin-bottom: 16px;">â€” æˆ–æ‰‹å‹•é¸æ“‡ â€”</div>

        <div class="form-group">
            <select id="season-select">
                <option value="" disabled selected>è«‹é¸æ“‡ä½ çš„å››å­£è‰²å½©...</option>
                <optgroup label="æ˜¥å­£ (Spring)">
                    <option value="æ˜¥å­£æ·ºè‰²å‹ (Light Spring)">æ˜¥å­£æ·ºè‰²å‹ (Light Spring)</option>
                    <option value="æ˜¥å­£æš–è‰²å‹ (Warm Spring)">æ˜¥å­£æš–è‰²å‹ (Warm Spring)</option>
                    <option value="æ˜¥å­£æ·¨è‰²å‹ (Clear Spring)">æ˜¥å­£æ·¨è‰²å‹ (Clear Spring)</option>
                </optgroup>
                <optgroup label="å¤å­£ (Summer)">
                    <option value="å¤å­£æ·ºè‰²å‹ (Light Summer)">å¤å­£æ·ºè‰²å‹ (Light Summer)</option>
                    <option value="å¤å­£å†·è‰²å‹ (Cool Summer)">å¤å­£å†·è‰²å‹ (Cool Summer)</option>
                    <option value="å¤å­£æŸ”å’Œå‹ (Soft Summer)">å¤å­£æŸ”å’Œå‹ (Soft Summer)</option>
                </optgroup>
                <optgroup label="ç§‹å­£ (Autumn)">
                    <option value="ç§‹å­£æŸ”å’Œå‹ (Soft Autumn)">ç§‹å­£æŸ”å’Œå‹ (Soft Autumn)</option>
                    <option value="ç§‹å­£æš–è‰²å‹ (Warm Autumn)">ç§‹å­£æš–è‰²å‹ (Warm Autumn)</option>
                    <option value="ç§‹å­£æ·±è‰²å‹ (Deep Autumn)">ç§‹å­£æ·±è‰²å‹ (Deep Autumn)</option>
                </optgroup>
                <optgroup label="å†¬å­£ (Winter)">
                    <option value="å†¬å­£æ·¨è‰²å‹ (Clear Winter)">å†¬å­£æ·¨è‰²å‹ (Clear Winter)</option>
                    <option value="å†¬å­£å†·è‰²å‹ (Cool Winter)">å†¬å­£å†·è‰²å‹ (Cool Winter)</option>
                    <option value="å†¬å­£æ·±è‰²å‹ (Deep Winter)">å†¬å­£æ·±è‰²å‹ (Deep Winter)</option>
                </optgroup>
            </select>
        </div>
        <button onclick="saveSeason()">è¨­å®šå®Œæˆ</button>
    </div>

    <!-- å€å¡Š 3ï¼šå•†å“åˆ†æå€ (ä¸»è¦åŠŸèƒ½å€) -->
    <div class="card hidden" id="analysis-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <span class="tag" id="current-season-tag">å°šæœªè¨­å®šå­£å‹</span>
            <button class="button-secondary" style="width: auto; padding: 4px 10px; margin: 0; font-size: 12px;" onclick="editSeason()">ä¿®æ”¹å­£å‹</button>
        </div>
        
        <h2 style="font-size: 18px; margin-top: 0;">2. é€™æ¬¾å½©å¦é©åˆæˆ‘å—ï¼Ÿ</h2>
        <div class="form-group">
            <input type="text" id="product-input" placeholder="ä¾‹å¦‚ï¼šMAC Chili, ROM&ND 25, æˆ–è²¼ä¸Šç¶²å€">
        </div>
        <button id="analyze-btn" onclick="analyzeProduct()">é–‹å§‹åˆ†æ</button>

        <div class="loading-container hidden" id="loading-spinner">
            <div class="loader"></div>
            <div class="loading-text">AI æ­£åœ¨æœå°‹èˆ‡åˆ†æç”¢å“æˆåˆ†...</div>
        </div>

        <div class="result-box hidden" id="result-container">
            <div class="result-score" id="result-score">-- åˆ†</div>
            <div class="result-title" id="result-summary">è‰²å½©ç¸½çµ</div>
            <p class="result-text" id="result-reason">åˆ†æåŸå› ...</p>
        </div>
    </div>

    <!-- å€å¡Š 3.5ï¼šå“ç‰Œå°‹å¯¶å€ -->
    <div class="card hidden" id="brand-section">
        <h2 style="font-size: 18px; margin-top: 0;">3. å“ç‰Œå°‹å¯¶ (åˆ—å‡ºé©åˆæˆ‘çš„è©²ç‰Œå•†å“)</h2>
        <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">ä¸çŸ¥é“è©²æŒ‘å“ªå€‹è‰²è™Ÿï¼Ÿç›´æ¥è¼¸å…¥å“ç‰Œï¼Œè®“ AI å¹«ä½ æŠŠé©åˆçš„ç”¢å“é€šé€šåˆ—å‡ºä¾†ï¼</p>
        
        <div class="form-group">
            <input type="text" id="brand-input" placeholder="ä¾‹å¦‚ï¼šMAC, æ¤æ‘ç§€, ROM&ND">
        </div>
        <button id="analyze-brand-btn" onclick="analyzeBrand()" style="background-color: #8B9BAA;">æœå°‹è©²ç‰Œé©åˆæˆ‘çš„ç”¢å“</button>

        <div class="loading-container hidden" id="brand-loading-spinner">
            <div class="loader" style="border-top-color: #8B9BAA;"></div>
            <div class="loading-text">AI æ­£åœ¨å¾å“ç‰Œå‹éŒ„ä¸­ç‚ºä½ æŒ‘é¸è‰²è™Ÿ...</div>
        </div>

        <div id="brand-result-list" style="margin-top: 16px;">
            <!-- å“ç‰Œæ¨è–¦é …ç›®æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
        </div>
    </div>

    <!-- å€å¡Š 4ï¼šå°ˆå±¬æ¨è–¦æ¸…å–® -->
    <div class="card hidden" id="recommendations-section">
        <h2 style="font-size: 18px; margin-top: 0; margin-bottom: 16px;">âœ¨ ä½ çš„å°ˆå±¬å‘½å®šå½©å¦</h2>
        
        <div class="loading-container hidden" id="rec-loading-spinner">
            <div class="loader"></div>
            <div class="loading-text">AI æ­£åœ¨ç‚ºä½ æŒ‘é¸æœ€é©åˆçš„å½©å¦...</div>
        </div>

        <div id="recommendations-list">
            <!-- æ¨è–¦é …ç›®æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
        </div>
    </div>

    <!-- é‡è¨­ API é‡‘é‘°æŒ‰éˆ• -->
    <div style="text-align: center; margin-top: 30px; margin-bottom: 30px;" id="reset-key-container" class="hidden">
        <button onclick="resetApiKey()" style="background: none; color: #999; border: 1px solid #ddd; width: auto; font-size: 13px; padding: 6px 16px;">ğŸ”‘ é‡æ–°è¨­å®š API é‡‘é‘°</button>
    </div>

</div>

<script>
    // --- ç³»çµ±ç‹€æ…‹ç®¡ç† ---
    const STATE = {
        apiKey: localStorage.getItem('gemini_api_key') || '',
        season: localStorage.getItem('user_season') || ''
    };

    let currentImageFile = null;

    // --- å…±ç”¨çš„éŒ¯èª¤è™•ç†å‡½æ•¸ ---
    async function handleApiError(response) {
        let errorMsg = `HTTP ç‹€æ…‹ç¢¼: ${response.status}`;
        try {
            const errData = await response.json();
            if (errData.error && errData.error.message) {
                errorMsg += `\n\n[ä¼ºæœå™¨å›å‚³ç´°ç¯€]:\n${errData.error.message}`;
            }
        } catch(e) {}
        return new Error(errorMsg);
    }

    // --- é é¢åˆå§‹åŒ– ---
    function init() {
        if (!STATE.apiKey) {
            document.getElementById('api-key-section').classList.remove('hidden');
        } else {
            document.getElementById('reset-key-container').classList.remove('hidden');
            if (!STATE.season) {
                document.getElementById('season-section').classList.remove('hidden');
            } else {
                showAnalysisSection();
            }
        }
    }

    // --- å„²å­˜ API Key ---
    function saveApiKey() {
        const keyInput = document.getElementById('api-key-input').value.trim();
        if (!keyInput) {
            alert('è«‹è¼¸å…¥ API Key');
            return;
        }
        STATE.apiKey = keyInput;
        localStorage.setItem('gemini_api_key', keyInput);
        document.getElementById('api-key-section').classList.add('hidden');
        document.getElementById('reset-key-container').classList.remove('hidden');
        
        if (!STATE.season) {
            document.getElementById('season-section').classList.remove('hidden');
        } else {
            showAnalysisSection();
        }
    }

    // --- é‡è¨­ API Key ---
    function resetApiKey() {
        if(confirm('ç¢ºå®šè¦æ¸…é™¤å„²å­˜çš„ API é‡‘é‘°å—ï¼Ÿ')) {
            localStorage.removeItem('gemini_api_key');
            STATE.apiKey = '';
            location.reload();
        }
    }

    // --- ç…§ç‰‡é è¦½èˆ‡æš«å­˜ ---
    function previewImage(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        currentImageFile = file; // æš«å­˜æª”æ¡ˆï¼Œä¾›å¾ŒçºŒå£“ç¸®ä½¿ç”¨

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.getElementById('photo-preview');
            img.src = e.target.result;
            document.getElementById('photo-preview-container').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }

    // --- ğŸŒŸ åœ–ç‰‡å£“ç¸®å‡½æ•¸ (å¾è¨˜å¸³ V10 ç§»æ¤ï¼Œé˜²æ­¢æª”æ¡ˆéå¤§) ---
    function compress(file) {
        return new Promise(resolve => {
            const r = new FileReader();
            r.readAsDataURL(file);
            r.onload = e => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const cvs = document.createElement('canvas');
                    const max = 1024; // ç¸®å°è‡³æœ€å¤§ 1024pxï¼Œçœæµé‡ä¸”åŠ å¿«è¾¨è­˜
                    let w = img.width, h = img.height;
                    if(w > max) { h *= max/w; w = max; }
                    cvs.width = w; cvs.height = h;
                    cvs.getContext('2d').drawImage(img,0,0,w,h);
                    resolve(cvs.toDataURL('image/jpeg', 0.8).split(',')[1]); // å›å‚³ base64
                };
            };
        });
    }

    // --- å‘¼å« Gemini Vision API åˆ†æç…§ç‰‡ ---
    async function analyzeSeasonFromPhoto() {
        if (!currentImageFile) {
            alert('è«‹å…ˆä¸Šå‚³æˆ–æ‹æ”ç…§ç‰‡ï¼');
            return;
        }

        const analyzeBtn = document.getElementById('analyze-photo-btn');
        const loadingSpinner = document.getElementById('season-loading-spinner');
        
        analyzeBtn.disabled = true;
        loadingSpinner.classList.remove('hidden');

        try {
            // å£“ç¸®åœ–ç‰‡
            const base64Data = await compress(currentImageFile);
            
            const prompt = `
                ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„éŸ“åœ‹ Personal Color è‰²å½©åˆ†æå¸«ã€‚
                è«‹ä»”ç´°åˆ†æé€™å¼µäººåƒç…§ç‰‡ä¸­äººç‰©çš„è†šè‰²åŸºèª¿ï¼ˆå†·æš–ï¼‰ã€åŸç”Ÿé«®è‰²å’Œç³å­”è‰²ï¼Œä¸¦åˆ¤æ–·ä»–å±¬æ–¼å“ªä¸€å€‹å››å­£è‰²å½©å‹åˆ¥ã€‚
                
                å¿…é ˆåš´æ ¼ä»¥ JSON æ ¼å¼å›å‚³ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
                {
                    "season": "è«‹å›å‚³ä¸‹åˆ—å­—ä¸²ä¸­çš„ã€Œå®Œå…¨åŒ¹é…ã€å€¼ä¹‹ä¸€ï¼šæ˜¥å­£æ·ºè‰²å‹ (Light Spring), æ˜¥å­£æš–è‰²å‹ (Warm Spring), æ˜¥å­£æ·¨è‰²å‹ (Clear Spring), å¤å­£æ·ºè‰²å‹ (Light Summer), å¤å­£å†·è‰²å‹ (Cool Summer), å¤å­£æŸ”å’Œå‹ (Soft Summer), ç§‹å­£æŸ”å’Œå‹ (Soft Autumn), ç§‹å­£æš–è‰²å‹ (Warm Autumn), ç§‹å­£æ·±è‰²å‹ (Deep Autumn), å†¬å­£æ·¨è‰²å‹ (Clear Winter), å†¬å­£å†·è‰²å‹ (Cool Winter), å†¬å­£æ·±è‰²å‹ (Deep Winter)",
                    "reason": "è©³ç´°èªªæ˜ä½ çš„åˆ¤æ–·åŸå› ï¼ˆç´„ 50 å­—å…§ï¼‰"
                }
                è«‹åªå›å‚³ JSON å­—ä¸²ï¼Œä¸è¦åŒ…å«ä»»ä½• markdown èªæ³• (å¦‚ \`\`\`json) æˆ–å…¶ä»–æ–‡å­—ã€‚
            `;

            // ã€æ›´æ–°ã€‘ä½¿ç”¨ä½ ç¢ºèªå¯ç”¨çš„ gemini-2.5-flash
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${STATE.apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        role: "user",
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: "image/jpeg", data: base64Data } }
                        ]
                    }],
                    generationConfig: {
                        temperature: 0.2,
                        responseMimeType: "application/json"
                    }
                })
            });

            if (!response.ok) {
                throw await handleApiError(response);
            }

            const data = await response.json();
            const textResult = data.candidates[0].content.parts[0].text;
            const resultJson = JSON.parse(textResult);

            const seasonSelect = document.getElementById('season-select');
            let matched = false;
            for (let i = 0; i < seasonSelect.options.length; i++) {
                if (seasonSelect.options[i].value === resultJson.season) {
                    seasonSelect.selectedIndex = i;
                    matched = true;
                    break;
                }
            }

            if (matched) {
                alert(`âœ… AI åˆ†æå®Œæˆï¼\n\nç³»çµ±åˆ¤å®šä½ æ˜¯ï¼š${resultJson.season}\n\nğŸ“ è¨ºæ–·å ±å‘Šï¼š${resultJson.reason}\n\n(å·²è‡ªå‹•ç‚ºæ‚¨é¸å–å¥½å­£å‹ï¼Œè«‹é»æ“Šã€Œè¨­å®šå®Œæˆã€ç¹¼çºŒä½¿ç”¨å½©å¦é‘‘å®š)`);
            } else {
                alert(`âœ… AI åˆ†æå®Œæˆï¼\n\nç³»çµ±åˆ¤å®šä½ æ˜¯ï¼š${resultJson.season}\nğŸ“ è¨ºæ–·å ±å‘Šï¼š${resultJson.reason}\n\n(è«‹åƒè€ƒæ­¤å»ºè­°ï¼Œæ‰‹å‹•åœ¨ä¸‹æ–¹é¸å–®é¸æ“‡æœ€æ¥è¿‘çš„å­£å‹)`);
            }

        } catch (error) {
            alert(`ç…§ç‰‡åˆ†æç™¼ç”ŸéŒ¯èª¤ï¼š\n${error.message}`);
            console.error(error);
        } finally {
            analyzeBtn.disabled = false;
            loadingSpinner.classList.add('hidden');
        }
    }

    // --- å„²å­˜å­£å‹ ---
    function saveSeason() {
        const seasonSelect = document.getElementById('season-select').value;
        if (!seasonSelect) {
            alert('è«‹é¸æ“‡ä¸€å€‹å­£å‹ï¼');
            return;
        }
        STATE.season = seasonSelect;
        localStorage.setItem('user_season', seasonSelect);
        document.getElementById('season-section').classList.add('hidden');
        showAnalysisSection();
    }

    // --- é‡æ–°ç·¨è¼¯å­£å‹ ---
    function editSeason() {
        document.getElementById('analysis-section').classList.add('hidden');
        document.getElementById('brand-section').classList.add('hidden');
        document.getElementById('recommendations-section').classList.add('hidden');
        document.getElementById('season-section').classList.remove('hidden');
        document.getElementById('season-select').value = STATE.season;
    }

    // --- é¡¯ç¤ºä¸»è¦åˆ†æå€ ---
    function showAnalysisSection() {
        document.getElementById('analysis-section').classList.remove('hidden');
        document.getElementById('brand-section').classList.remove('hidden');
        document.getElementById('current-season-tag').textContent = `æˆ‘çš„å­£å‹ï¼š${STATE.season}`;
        document.getElementById('result-container').classList.add('hidden');
        document.getElementById('product-input').value = '';
        document.getElementById('brand-input').value = '';
        document.getElementById('brand-result-list').innerHTML = '';
        
        fetchRecommendations();
    }

    // --- å‘¼å« Gemini API é€²è¡Œå“ç‰Œç”¢å“æ¨è–¦ ---
    async function analyzeBrand() {
        const brandInput = document.getElementById('brand-input').value.trim();
        if (!brandInput) {
            alert('è«‹è¼¸å…¥å½©å¦å“ç‰Œåç¨±ï¼');
            return;
        }

        const analyzeBtn = document.getElementById('analyze-brand-btn');
        const loadingSpinner = document.getElementById('brand-loading-spinner');
        const resultList = document.getElementById('brand-result-list');
        
        analyzeBtn.disabled = true;
        loadingSpinner.classList.remove('hidden');
        resultList.innerHTML = '';

        try {
            const prompt = `
                ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„éŸ“åœ‹ Personal Color è‰²å½©åˆ†æå¸«ã€‚
                æˆ‘çš„å€‹äººè‰²å½©å­£å‹æ˜¯ï¼šã€Œ${STATE.season}ã€ã€‚
                æˆ‘ç¾åœ¨æƒ³è³¼è²·ã€Œ${brandInput}ã€é€™å€‹å“ç‰Œçš„å½©å¦ã€‚
                è«‹å¾é€™å€‹å“ç‰Œä¸­ï¼Œåš´é¸ 3 åˆ° 5 æ¬¾ã€Œæœ€é©åˆã€æˆ‘é€™å€‹å­£å‹çš„å…·é«”ç”¢å“ï¼ˆå¿…é ˆåŒ…å«æ˜ç¢ºçš„è‰²è™Ÿï¼Œä¾‹å¦‚ï¼šå”‡è†ã€è…®ç´…ã€çœ¼å½±ï¼‰ã€‚
                
                å¿…é ˆåš´æ ¼ä»¥ JSON é™£åˆ— (Array) æ ¼å¼å›å‚³ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
                [
                    {
                        "product": "ç”¢å“åç¨±èˆ‡æ˜ç¢ºè‰²è™Ÿ (ä¾‹å¦‚ï¼šè¶…æ°´æ„ŸæŒè‰²å”‡é‡‰ #03)",
                        "type": "é¡åˆ¥ (ä¾‹å¦‚ï¼šå”‡è†)",
                        "reason": "è©³ç´°èªªæ˜æ¨è–¦åŸå› åŠé¡è‰²æè¿°ï¼ˆç´„30å­—ï¼‰"
                    }
                ]
                è«‹åªå›å‚³ JSON é™£åˆ—ï¼Œä¸è¦åŒ…å«ä»»ä½• markdown èªæ³•æˆ–å…¶ä»–æ–‡å­—ã€‚
            `;

            // ã€æ›´æ–°ã€‘ä½¿ç”¨ gemini-2.5-flash
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${STATE.apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        temperature: 0.3,
                        responseMimeType: "application/json"
                    }
                })
            });

            if (!response.ok) {
                throw await handleApiError(response);
            }

            const data = await response.json();
            const textResult = data.candidates[0].content.parts[0].text;
            const resultJson = JSON.parse(textResult);

            resultList.innerHTML = resultJson.map(item => `
                <div class="rec-item">
                    <div class="rec-header">
                        <span class="rec-brand">${brandInput}</span>
                        <span class="rec-type-tag" style="background-color: #E9ECEF; color: #627585;">${item.type}</span>
                    </div>
                    <div class="rec-product">${item.product}</div>
                    <p class="rec-reason">${item.reason}</p>
                </div>
            `).join('');

        } catch (error) {
            alert(`ç™¼ç”ŸéŒ¯èª¤ï¼š\n${error.message}`);
            console.error(error);
            resultList.innerHTML = '<p style="color:red; font-size: 13px;">ç„¡æ³•å–å¾—å“ç‰Œè³‡æ–™ï¼Œè«‹ç¢ºèª API ç‹€æ…‹æˆ–ç¨å¾Œé‡è©¦ã€‚</p>';
        } finally {
            analyzeBtn.disabled = false;
            loadingSpinner.classList.add('hidden');
        }
    }

    // --- è‡ªå‹•ç²å–å°ˆå±¬å½©å¦æ¨è–¦ ---
    async function fetchRecommendations() {
        const recSection = document.getElementById('recommendations-section');
        const recList = document.getElementById('recommendations-list');
        const loadingSpinner = document.getElementById('rec-loading-spinner');

        recSection.classList.remove('hidden');

        const cacheKey = `recs_${STATE.season}`;
        const cachedData = localStorage.getItem(cacheKey);
        
        if (cachedData) {
            renderRecommendations(JSON.parse(cachedData));
            return;
        }

        recList.innerHTML = '';
        loadingSpinner.classList.remove('hidden');

        try {
            const prompt = `
                ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„éŸ“åœ‹ Personal Color è‰²å½©åˆ†æå¸«ã€‚
                æˆ‘çš„å€‹äººè‰²å½©å­£å‹æ˜¯ï¼šã€Œ${STATE.season}ã€ã€‚
                è«‹ç‚ºæˆ‘æ¨è–¦ 3 æ¬¾ç›®å‰å¸‚é¢ä¸Šéå¸¸å—æ­¡è¿ã€ä¸”ã€Œçµ•å°é©åˆã€æˆ‘é€™å€‹å­£å‹çš„å½©å¦ç”¢å“ï¼ˆå»ºè­°åŒ…å«å”‡è†ã€è…®ç´…æˆ–çœ¼å½±ï¼‰ã€‚
                
                å¿…é ˆåš´æ ¼ä»¥ JSON é™£åˆ— (Array) æ ¼å¼å›å‚³ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
                [
                    {
                        "brand": "å“ç‰Œåç¨± (ä¾‹å¦‚ï¼šMAC, ROM&ND)",
                        "product": "ç”¢å“åç¨±èˆ‡è‰²è™Ÿ (ä¾‹å¦‚ï¼šéœ§å¹»æ€§æ„Ÿå”‡è† Chili)",
                        "type": "é¡åˆ¥ (ä¾‹å¦‚ï¼šå”‡è†)",
                        "reason": "ä¸€å¥è©±èªªæ˜æ¨è–¦åŸå› ï¼ˆç´„20-30å­—ï¼‰"
                    }
                ]
                è«‹åªå›å‚³ JSON é™£åˆ—ï¼Œä¸è¦åŒ…å«ä»»ä½• markdown èªæ³•æˆ–å…¶ä»–æ–‡å­—ã€‚
            `;

            // ã€æ›´æ–°ã€‘ä½¿ç”¨ gemini-2.5-flash
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${STATE.apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        temperature: 0.4,
                        responseMimeType: "application/json"
                    }
                })
            });

            if (!response.ok) {
                throw await handleApiError(response);
            }

            const data = await response.json();
            const textResult = data.candidates[0].content.parts[0].text;
            const resultJson = JSON.parse(textResult);

            localStorage.setItem(cacheKey, JSON.stringify(resultJson));
            renderRecommendations(resultJson);

        } catch (error) {
            console.error(error);
            recList.innerHTML = `<p style="color:red; font-size: 13px;">è¼‰å…¥æ¨è–¦æ¸…å–®å¤±æ•—ã€‚\n${error.message}</p>`;
        } finally {
            loadingSpinner.classList.add('hidden');
        }
    }

    // --- æ¸²æŸ“æ¨è–¦æ¸…å–®ç•«é¢ ---
    function renderRecommendations(items) {
        const recList = document.getElementById('recommendations-list');
        recList.innerHTML = items.map(item => `
            <div class="rec-item">
                <div class="rec-header">
                    <span class="rec-brand">${item.brand}</span>
                    <span class="rec-type-tag">${item.type}</span>
                </div>
                <div class="rec-product">${item.product}</div>
                <p class="rec-reason">${item.reason}</p>
            </div>
        `).join('');
    }

    // --- å‘¼å« Gemini API é€²è¡Œå–®å“åˆ†æ ---
    async function analyzeProduct() {
        const productInput = document.getElementById('product-input').value.trim();
        if (!productInput) {
            alert('è«‹è¼¸å…¥å½©å¦å“ç‰Œèˆ‡è‰²è™Ÿï¼Œæˆ–è²¼ä¸Šç¶²å€ï¼');
            return;
        }

        const analyzeBtn = document.getElementById('analyze-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const resultContainer = document.getElementById('result-container');
        
        analyzeBtn.disabled = true;
        loadingSpinner.classList.remove('hidden');
        resultContainer.classList.add('hidden');

        try {
            const prompt = `
                ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„éŸ“åœ‹ Personal Color è‰²å½©åˆ†æå¸«ã€‚
                æˆ‘çš„å€‹äººè‰²å½©å­£å‹æ˜¯ï¼šã€Œ${STATE.season}ã€ã€‚
                è«‹å¹«æˆ‘åˆ†æé€™æ¬¾å½©å¦ç”¢å“ï¼šã€Œ${productInput}ã€ã€‚
                
                è«‹æ ¹æ“šä½ çš„çŸ¥è­˜åº«ï¼ˆå¦‚æœæ˜¯ç¶²å€è«‹åˆ†æè©²ç¶²é å…§å®¹ï¼‰ï¼Œåˆ¤æ–·é€™æ¬¾ç”¢å“çš„çœŸå¯¦è‰²å½©å±¬æ€§ï¼ˆå†·æš–èª¿ã€æ˜åº¦ã€å½©åº¦ï¼‰ï¼Œä¸¦è©•ä¼°å®ƒæ˜¯å¦é©åˆæˆ‘çš„å­£å‹ã€‚
                
                å¿…é ˆåš´æ ¼ä»¥ JSON æ ¼å¼å›å‚³ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
                {
                    "score": æ•¸å­— (1-100ï¼Œè¡¨ç¤ºé©åˆç¨‹åº¦),
                    "summary": "ä¸€å¥è©±ç¸½çµè©²ç”¢å“çš„çœŸå¯¦é¡è‰²ï¼Œä¾‹å¦‚ï¼šå¸¶ç°èª¿çš„ä¹¾ç‡¥ç«ç‘°è‰²",
                    "reason": "è©³ç´°èªªæ˜ç‚ºä»€éº¼é©åˆæˆ–ä¸é©åˆæˆ‘ï¼ˆç´„50-80å­—ï¼‰"
                }
                è«‹åªå›å‚³ JSON å­—ä¸²ï¼Œä¸è¦åŒ…å«ä»»ä½• markdown èªæ³• (å¦‚ \`\`\`json) æˆ–å…¶ä»–æ–‡å­—ã€‚
            `;

            // ã€æ›´æ–°ã€‘ä½¿ç”¨ gemini-2.5-flash
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${STATE.apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: prompt }]
                    }],
                    generationConfig: {
                        temperature: 0.2,
                        responseMimeType: "application/json"
                    }
                })
            });

            if (!response.ok) {
                throw await handleApiError(response);
            }

            const data = await response.json();
            
            let textResult = data.candidates[0].content.parts[0].text;
            let resultJson;
            
            try {
                resultJson = JSON.parse(textResult);
            } catch (e) {
                console.error("JSON è§£æå¤±æ•—:", textResult);
                throw new Error("AI å›å‚³çš„æ ¼å¼æœ‰èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚");
            }

            document.getElementById('result-score').textContent = `${resultJson.score} åˆ†`;
            document.getElementById('result-score').style.color = resultJson.score >= 80 ? '#7B8D82' : (resultJson.score >= 60 ? '#C19A6B' : '#B47A7A');
            document.getElementById('result-summary').textContent = resultJson.summary;
            document.getElementById('result-reason').textContent = resultJson.reason;
            
            resultContainer.classList.remove('hidden');

        } catch (error) {
            alert(`ç™¼ç”ŸéŒ¯èª¤ï¼š\n${error.message}`);
            console.error(error);
        } finally {
            analyzeBtn.disabled = false;
            loadingSpinner.classList.add('hidden');
        }
    }

    // åŸ·è¡Œåˆå§‹åŒ–
    init();

</script>
</body>
</html>
